# [gcode_macro G28]
# rename_existing: G28.1
# gcode:
#     STARTUP

# [gcode_macro STARTUP]
# description: Senkt Z Achse(n) f√ºr Bett-Ausrichtung, absolute Bewegung
# gcode:
#     # Stepper aktivieren f√ºr TMC-Kommunikation
#     SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
#     SET_STEPPER_ENABLE STEPPER=stepper_z1 ENABLE=1
#     SET_STEPPER_ENABLE STEPPER=stepper_z2 ENABLE=1

#     # Strom reduzieren (0.3A f√ºr sanften Stall, tune auf 0.2-0.4A)
#     SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.11
#     SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.11
#     SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=0.11
#     G4 P1000  ; Warte auf Stabilisierung
#     RESPOND PREFIX=info MSG="Strom auf 0,11 A gesetzt, Register stabilisiert."

#     # Optional: TMC dumpen f√ºr Check (im Log pr√ºfen: irun ~10-15)
#     # DUMP_TMC STEPPER=stepper_z
#     # DUMP_TMC STEPPER=stepper_z1
#     # DUMP_TMC STEPPER=stepper_z2

#     # Z auf 0 setzen und langsam fahren (gegen Stall)
#     G90
#     SET_KINEMATIC_POSITION Z=0
#     G0 Z160 F1200
#     RESPOND PREFIX=info MSG="Z auf 0 gesetzt und auf Z=160 f√ºr Bett-Ausrichtung bewegt"

#     # Strom wiederherstellen
#     SET_TMC_CURRENT STEPPER=stepper_z CURRENT=1.0
#     SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=1.0
#     SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=1.0
#     RESPOND PREFIX=info MSG="Strom auf normale Werte zur√ºckgesetzt"

#     # X/Y homing
#     G28 X Y
#     ATTACH_PROBE_LOCK
#     # # 9. Z mit Probe neu homen
#     G28 Z
#     Z_TILT_ADJUST 
#     DOCK_PROBE_UNLOCK

#     # 10. Feedback
#     RESPOND MSG="Let's do it!"



[gcode_macro STARTUP]
description: Senkt Z Achse(n) f√ºr Bett-Ausrichtung, absolute Bewegung
gcode:
    # -----------------------------
    # Urspr√ºngliche Stromwerte holen
    # -----------------------------
    {% if 'tmc2209 stepper_z' in printer.configfile.settings %}
        {% set original_z_current = printer.configfile.settings['tmc2209 stepper_z'].run_current %}
    {% else %}
        {% set original_z_current = 0.8 %}
    {% endif %}

    {% if 'tmc2209 stepper_z1' in printer.configfile.settings %}
        {% set original_z1_current = printer.configfile.settings['tmc2209 stepper_z1'].run_current %}
    {% else %}
        {% set original_z1_current = 0.8 %}
    {% endif %}

    {% if 'tmc2209 stepper_z2' in printer.configfile.settings %}
        {% set original_z2_current = printer.configfile.settings['tmc2209 stepper_z2'].run_current %}
    {% else %}
        {% set original_z2_current = 0.8 %}
    {% endif %}

    RESPOND PREFIX=info MSG="Urspr√ºngliche Stromwerte gespeichert: Z={original_z_current}, Z1={original_z1_current}, Z2={original_z2_current}"

    # -----------------------------
    # Stepper aktivieren
    # -----------------------------
    SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
    {% if printer.configfile.settings.stepper_z1 is defined %}
        SET_STEPPER_ENABLE STEPPER=stepper_z1 ENABLE=1
    {% endif %}
    {% if printer.configfile.settings.stepper_z2 is defined %}
        SET_STEPPER_ENABLE STEPPER=stepper_z2 ENABLE=1
    {% endif %}

    RESPOND PREFIX=info MSG="Z-Stepper aktiviert"

    # -----------------------------
    # Strom reduzieren
    # -----------------------------
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.11
    {% if printer.configfile.settings.stepper_z1 is defined %}
        SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.11
    {% endif %}
    {% if printer.configfile.settings.stepper_z2 is defined %}
        SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=0.11
    {% endif %}

    G4 P1000
    RESPOND PREFIX=info MSG="Strom auf 0.11 A gesetzt, Register stabilisiert"

    # -----------------------------
    # Z Bewegung
    # -----------------------------
    G90
    SET_KINEMATIC_POSITION Z=0
    G0 Z160 F1200
    RESPOND PREFIX=info MSG="Z auf 0 gesetzt und auf Z=160 f√ºr Bett-Ausrichtung bewegt"

    # -----------------------------
    # Strom wiederherstellen
    # -----------------------------
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={original_z_current}
    {% if printer.configfile.settings.stepper_z1 is defined %}
        SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={original_z1_current}
    {% endif %}
    {% if printer.configfile.settings.stepper_z2 is defined %}
        SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={original_z2_current}
    {% endif %}

    RESPOND PREFIX=info MSG="Strom auf urspr√ºngliche Wert {original_z1_current}A zur√ºckgesetzt"

    # -----------------------------
    # Homing & Bett-Ausrichtung
    # -----------------------------
    G28 X Y
    RESPOND PREFIX=info MSG="X/Y homed"

    ATTACH_PROBE_LOCK
    G28 Z
    RESPOND PREFIX=info MSG="Z homed"

    Z_TILT_ADJUST
    RESPOND PREFIX=info MSG="Z-Tilt abgeschlossen"
##########
   RESPOND TYPE=echo MSG="Current print_stats.state: {printer.print_stats.state}"
   
   {% if printer.print_stats.state not in ['printing', 'paused'] %}
    # ‚Üí Nur docken, wenn KEIN Druck l√§uft oder pausiert ist
   _Probe_Unlock
   DOCK_PROBE
   {% else %}
   RESPOND TYPE=echo MSG="Probe bleibt attached - warte auf Temp."
   {% endif %}
    
   RESPOND MSG="Let's do it! üöÄ"


