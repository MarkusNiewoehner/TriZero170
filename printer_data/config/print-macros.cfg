#START_PRINT EXTRUDER_TEMP=[first_layer_temperature] BED_TEMP=[first_layer_bed_temperature]

[gcode_macro START_PRINT]
description: Start-Makro für OrcaSlicer mit Klicky Probe, Z-Tilt, Bed Mesh & Purge
gcode:
    SET_PIN PIN=caselight VALUE=1
    SET_FAN_SPEED FAN=Umluft SPEED=1
    
    # ==============================================
    # 1. Sicherheit & Vorbereitung
    # ==============================================
    CLEAR_PAUSE
    #SET_IDLE_TIMEOUT TIMEOUT=0

    # ==============================================
    # 2. Heizbett & Heißlauf vorheizen (parallel)
    # ==============================================
    M140 S{params.BED_TEMP|default(60)|float}           ; Bett-Temperatur setzen
    M104 S150                                           ; Heißlauf auf 150 °C vorheizen

    # ==============================================
    # 3. Homing & Probe laden
    # ==============================================
    QUERY_PRINT_STATE
    STARTUP                                                 ; Alle Achsen homen
    # ATTACH_PROBE_LOCK                                   ; Klicky Probe anbringen
    # G28 Z
    # ==============================================
    # 4. Z-Tilt & Bed Mesh
    # ==============================================
    # Z_TILT_ADJUST                                       ; Gantry/Bett nivellieren
   
    # ==============================================
    # 5. Auf finale Drucktemperatur warten – aber nur bis ca. Ziel erreicht
    # ==============================================
    
    # # Heißlauf und Bett starten (ohne zu warten)
    # M104 S{params.EXTRUDER_TEMP|default(200)|float}   ; Heißlauf starten, aber nicht warten
    # M140 S{params.BED_TEMP|default(60)|float}         ; Bett starten, aber nicht warten
            
    # # Jetzt warten, bis beide Temperaturen fast erreicht sind (z. B. -2 °C unter Ziel)
    # TEMPERATURE_WAIT SENSOR=extruder     MINIMUM={params.EXTRUDER_TEMP|default(200)|float - 2}
    # TEMPERATURE_WAIT SENSOR=heater_bed   MINIMUM={params.BED_TEMP|default(60)|float - 2}
    
    # # Optional: Noch eine kleine Sicherheitspause (1–3 Sekunden), damit es wirklich druckbereit ist
    # G4 P2000  ; 2 Sekunden warten
    ; Bett starten
    M140 S{params.BED_TEMP|default(60)|float}   ; Bett auf Ziel-Temperatur setzen
    
    ; Auf Bett warten, bis es fast die Ziel-Temperatur erreicht hat (-2 °C)
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={params.BED_TEMP|default(60)|float - 2}
    
    ; Optional: kleine Pause, damit das Bett wirklich stabil ist
    G4 P2000   ; 2 Sekunden warten
    
    ; Jetzt erst Nozzle (Hotend) starten
    M104 S{params.EXTRUDER_TEMP|default(200)|float}   ; Hotend auf Ziel-Temperatur setzen
    
    ; Auf Hotend warten, bis es fast die Ziel-Temperatur erreicht hat (-2 °C)
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.EXTRUDER_TEMP|default(200)|float - 2}
    
    ; Kleine Sicherheitspause (optional)
    G4 P1500   ; 1,5 Sekunden warten

     # Bed Mesh – Profil laden oder neu erstellen
    {% if params.BED_MESH_PROFILE %}
        BED_MESH_PROFILE LOAD={params.BED_MESH_PROFILE}
    {% else %}
        BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=5 #BED_MESH_CALIBRATE
    {% endif %}
    DOCK_PROBE_UNLOCK
    SET_PRESSURE_ADVANCE ADVANCE=0.04

    
    # ==============================================
    # 6. Purge-Line / Prime
    # ==============================================
    PURGE_LINE 
    # ==============================================
    # 7. In Druckbereich fahren & fertig melden
    # ==============================================
    G1 Z2 F3000                                         ; Sicherheitsabstand
    G0 X85 Y85 F8000                                ; In Bettmitte parken

    # Optional: Klicky-Status-LED
    _klicky_status_ready
    SET_FAN_SPEED FAN=Abluft SPEED=0.8

    RESPOND MSG="Druckstart abgeschlossen – ready to print!"




[gcode_macro END_PRINT]
description: Druckende - Filament zurückziehen, Nozzle parken, Z auf 130 mm absenken, Heizungen aus, Lüfter aus, Motoren (außer Z) deaktivieren
gcode:
    ##### Sicherheits-Checks #####
    {% set user_vars = printer["gcode_macro _USER_VARIABLES"]|default({}) %}
    {% set z_park_height = params.Z_PARK|default(120)|float %}
    {% set retract = params.RETRACT|default(2.0)|float %}
    {% set retract_speed = params.RETRACT_SPEED|default(40)|float * 60 %}

    ##### Status speichern (falls du PAUSE/RESUME nutzt) #####
    SAVE_GCODE_STATE NAME=END_PRINT_state

    ##### Filament zurückziehen #####
    G91                            ; relative positioning
    G1 E-{retract} F{retract_speed} ; kurzer Retract (vermeidet Stringing/Ooze)
    G90                            ; wieder absolut

    ##### Nozzle anheben (falls noch nicht hoch genug) #####
    {% if printer.toolhead.position.z < (z_park_height - 10) %}
        G1 Z{z_park_height} F3000
    {% else %}
        G1 Z{z_park_height} F3000
    {% endif %}

    ##### Nozzle sicher parken (rechts hinten auf deinem 170×170 Bett) #####
    G90                            ; absolut
    G1 X155 Y155 F10000            ; Park-Position (rechts hinten, 15 mm Rand)
                                   ; → alternativ X160 Y160 falls dein Bett genau 170×170 ist

    ##### Alle Heizungen ausschalten #####
    M104 S0                        ; Hotend aus
    M140 S0                        ; Bett aus

    ##### Lüfter ausschalten #####
    M106 S0                        ; Part Cooling Fan aus
    M107                           ; (manchmal noch nötig bei älteren Firmwares)
    #SET_FAN_SPEED FAN=FAN SPEED=0
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0

    ##### Motoren deaktivieren (Z bleibt aktiv, damit das Bett nicht absackt) #####
    M84 X Y E                      ; X, Y und Extruder abschalten
    # M84                          ; alternativ alle Motoren aus (wenn du willst, dass Z auch abschaltet)

    ##### Optionale Nachbereitung #####
    # BED_MESH_CLEAR               ; Mesh löschen (falls du adaptive Meshes nutzt und sauberen Start willst)
    # TURN_OFF_HEATERS             ; redundante Sicherheit (manchmal nützlich)

    ##### Status wiederherstellen #####
    RESTORE_GCODE_STATE NAME=END_PRINT_state

    ##### Optional: Meldung ans Display / Fluidd #####
    {action_respond_info("Druck beendet – Z auf %.1f mm abgesenkt" % z_park_height)}

  	SET_FAN_SPEED FAN=Abluft SPEED=0.00
    SET_FAN_SPEED FAN=Umluft SPEED=0.00
    SET_PIN PIN=caselight VALUE=0.02
    
    
    M117 Druck beendet
    TURNOFF_AFTERPRINT

[gcode_macro PURGE_LINE]
gcode:
    G90                         ; absolute Positionierung
    M83                         ; relative Extrusion
    G92 E0                      ; Extruder zurücksetzen

    ; Startposition (leicht angepasst für mehr Platz)
    G1 X5 Y5 Z0.20 F6000

    ; Blob mit längerer X-Bewegung (doppelt: ~4 mm statt 2 mm)
    G1 E15.0 F300               ; mehr Material für den Blob (angepasst)

    ; Vorwärts-Linie: ~80 mm statt 40 mm, immer noch ~0.5 mm breit
    G1 X85 E3.2 F600            ; doppelte Strecke → doppelte Extrusion

    ; Z anheben auf 0.40 und rückwärts fahren ~60 mm statt 30 mm, ~0.8 mm Bahn
    G1 Z0.40 F1200
    G1 X25 E3.84 F600           ; doppelte Extrusion für die Rückwärts-Bahn

    ; Extrusion stoppen, wieder vorwärts fahren und minimal retracten
    G1 X85 E-1.0 F3000          ; etwas mehr Retract wegen längerer Bahn

    ; Z sicher anheben (entkommentiert und etwas höher für Sicherheit)
    G1 Z2.0 F3000

    ; --- Ende Purge Line (doppelt so lang / doppelt so viel Material) ---