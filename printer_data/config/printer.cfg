[include mainsail.cfg]
[include macros.cfg]
[include ebb36.cfg]
[include neopixel.cfg]
[include servo.cfg]
[include stepper.cfg]
[include force.cfg]
[include sensorless_homing.cfg]
[include klicky-probe/klicky-probe.cfg]
[include print-macros.cfg]
[include z-brake.cfg]
[include shell_command.cfg]
#[include klipper_tmc_autotune/autotune.cfg]
#[include autotune_database.cfg]
[include shaketune.cfg]
# [output_pin test_brake]
# pin: PB15
# value: 1          # Initialwert: 1 = Brake aktiv (kein GND → Wicklungen kurz), passe an deine Polarität an
# shutdown_value: 1 # Sicher: Bei Klipper-Stop Brake aktiv halten

# [homing_override]
# gcode:


[mcu]
canbus_uuid: a785be9bda81 #36cbaee86293 #a2bb18817f51 #2b36ae04b020

[mcu EBBCan]
canbus_uuid: ad133ba84a1e

[exclude_object]

[gcode_arcs]
resolution: 0.1

# [fan]
# pin: PA13
# cycle_time: 0.00004
# #cycle_time: 0.01

[gcode_macro QUERY_PRINT_STATE]
gcode:
    {% set state = printer.print_stats.state|default("unbekannt") %}
    {action_respond_info("print_stats.state = " ~ state)}
    M117 {state}

[printer]
kinematics: corexy
max_velocity: 550 #300 
max_accel:7000		        #Max 4000
max_z_velocity: 25			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 500
square_corner_velocity: 5.0
# kinematics: corexy
# max_velocity: 650
# max_accel: 10000        
# #max_accel_to_decel: 7000
# max_z_velocity: 25
# max_z_accel: 500
# square_corner_velocity: 7.0

###################
#  Z-Brake
####################

# [multi_pin z_enables]
# pins: !PE8, !PE3, !PE5, PC8 #PB15
# # Erklärung: 
# # - ! vor den Stepper-Enables: Weil TMC-Enables active-low sind (low = Motoren enabled).
# # - Kein ! vor PB15: Angenommen, low (GND) deaktiviert die Bremsung (Relais an). Wenn umgekehrt (high deaktiviert Bremsung)

# [delayed_gcode lower_current]
# initial_duration: 2
# gcode:
#     # -----------------------------
#     # Stepper aktivieren
#     # -----------------------------
#     SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
#     {% if printer.configfile.settings.stepper_z1 is defined %}
#         SET_STEPPER_ENABLE STEPPER=stepper_z1 ENABLE=1
#     {% endif %}
#     {% if printer.configfile.settings.stepper_z2 is defined %}
#         SET_STEPPER_ENABLE STEPPER=stepper_z2 ENABLE=1
#     {% endif %}

#     RESPOND PREFIX=info MSG="Z-Stepper aktiviert"

#     # -----------------------------
#     # Strom reduzieren
#     # -----------------------------
#     SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.11
#     {% if printer.configfile.settings.stepper_z1 is defined %}
#         SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.11
#     {% endif %}
#     {% if printer.configfile.settings.stepper_z2 is defined %}
#         SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=0.11
#     {% endif %}

#     G4 P1000
#     RESPOND PREFIX=info MSG="Strom auf 0.11 A gesetzt, Register stabilisiert"


# ───────────────────────────────────────────────────────────────
# Z-Tilt – Probe-Punkte (anpassen an deine Bed-Größe 170×170)
# ───────────────────────────────────────────────────────────────

[gcode_macro Z_TILT_SAFE]
gcode:
    {% set HOME = printer.toolhead.homed_axes|lower %}
    
    {% if 'z' not in HOME %}
        RESPOND TYPE=error MSG="Z_TILT_SAFE: Z-Achse ist nicht gehomed → Abbruch"
        M117 Z nicht gehomed!
    {% elif 'x' not in HOME or 'y' not in HOME %}
        G28 X Y                  ; X und Y nachholen (meist schnell)
        G28 Z                    ; dann Z home
        Z_TILT_ADJUST
    {% else %}
        Z_TILT_ADJUST
    {% endif %}


[z_tilt]
z_positions:
   -50,  30      # vorne links  = stepper_z   (bleibt gleich – außerhalb des Betts!)
    85, 150      # hinten mitte = stepper_z1  (bleibt gleich – passt noch)
   220,  30      # vorne rechts = stepper_z2  (bleibt gleich – außerhalb des Betts!)

points:
    20,  10      # vorne links   – etwas mehr Abstand zum Rand als 25→20
     85, 150     # hinten mitte  – unverändert, liegt perfekt über der mittleren Spindel
    145,  10     # vorne rechts  – von 145→145 (oder 140–145), passt noch gut rein

speed: 800
horizontal_move_z: 13
retries: 5
retry_tolerance: 0.020

# ───────────────────────────────────────────────────────────────
# Bed-Mesh
# ───────────────────────────────────────────────────────────────

[bed_mesh]
speed: 500 #120
horizontal_move_z: 13
# mesh_min: 30, 42       # Y-min + y_offset (30 + 12 = 42)
# mesh_max: 140, 158     # Y-max - y_offset (170 - 12 = 158, X etwas eingeschränkt)
mesh_min: 15, 15        # Nozzle-Startpunkt vorne-links (X,Y) – ca. 15 mm Rand
mesh_max: 150, 150      # Nozzle-Endpunkt hinten-rechts – 165-15 = 150
probe_count: 5,5       # oder 6,6 für mehr Punkte
algorithm: bicubic
fade_start: 1
fade_end: 10

# ───────────────────────────────────────────────────────────────
# Probe (Klicky) – PIN und Offsets ANPASSEN!!!
# ───────────────────────────────────────────────────────────────

[probe]
pin: EBBCan: PB9              # ← Häufiger Pin für Probe auf Spider – PRÜFE dein Wiring!
x_offset: 0          # Beispiel – deine reale Klicky-Position
y_offset: 12
#z_offset: 0            # Wird mit PROBE_CALIBRATE gesetzt
sample_retract_dist: 2.0
speed: 5.0
lift_speed: 30
samples: 1
samples_result: median
sample_retract_dist: 2
samples_tolerance: 0.040
samples_tolerance_retries: 2



#####################################################################
#   Extruder
#####################################################################


[extruder]
control = pid
pid_Kp=38.749 
pid_Ki=14.351 
pid_Kd=26.156


#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
##	SSR Pin - In BED OUT position
heater_pin: PG11
sensor_type: NTC 100K MGB18-104F39050L32 #Generic 3950 # NTC 100K MGB18-104F39050L32
pullup_resistor: 2200
sensor_pin: PA1 # TB Position
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 1
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769




#Chamber Temperatursensor am Spider V3.0 - T2
[temperature_sensor chamber]
sensor_type: PT1000          
sensor_pin: PA2     
pullup_resistor: 2200
min_temp: -20                      
max_temp: 120                     
# Optional: Zeigt "C" statt langer Bezeichnung in der Fluidd/Mainsail-Übersicht
gcode_id: C


[fan_generic Abluft]
#pin: PE5 
pin: PB3
max_power: 1.0
shutdown_speed: 0
kick_start_time: 0.3
off_below: 0.02
#cycle_time: 0.0005

[fan_generic Umluft]
#pin: PE5 
pin: PB7
max_power: 1.0
shutdown_speed: 0
kick_start_time: 0.3
off_below: 0.02
#cycle_time: 0.0005


[heater_fan heatbed_fan]
#  Exhaust fan - In E2 OUT Positon
pin: PF9
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
heater: heater_bed
heater_temp: 60
fan_speed: 1
cycle_time: 0.01


#####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800
   
[input_shaper]
# Hier kommen später die Ergebnisse rein, z. B.:
# shaper_freq_x: 50
# shaper_type_x: mzv
# shaper_freq_y: 45
# shaper_type_y: ei

[resonance_tester]
accel_chip: adxl345  # oder dein Chip-Name, z. B. lis2dw, mpu-9250 usw.
probe_points: 85,85,25  # Beispiel: Mittelpunkt deines Betts, Z-Höhe wo du testest

[gcode_macro _CLIENT_VARIABLE]
#variable_use_custom_pos   : False ; use custom park coordinates for x,y [True/False]
#variable_custom_park_x    : 0.0   ; custom x position; value must be within your defined min and max of X
#variable_custom_park_y    : 0.0   ; custom y position; value must be within your defined min and max of Y
#variable_custom_park_dz   : 2.0   ; custom dz value; the value in mm to lift the nozzle when move to park position
#variable_retract          : 1.0   ; the value to retract while PAUSE
#variable_cancel_retract   : 5.0   ; the value to retract while CANCEL_PRINT
#variable_speed_retract    : 35.0  ; retract speed in mm/s
#variable_unretract        : 1.0   ; the value to unretract while RESUME
#variable_speed_unretract  : 35.0  ; unretract speed in mm/s
#variable_speed_hop        : 15.0  ; z move speed in mm/s
#variable_speed_move       : 100.0 ; move speed in mm/s
variable_park_at_cancel   : True ; allow to move the toolhead to park while execute CANCEL_PRINT [True/False]
variable_park_at_cancel_x : 85  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
variable_park_at_cancel_y : 150  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
# !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
#variable_use_fw_retract   : False ; use fw_retraction instead of the manual version [True/False]
#variable_idle_timeout     : 0     ; time in sec until idle_timeout kicks in. Value 0 means that no value will be set or restored
gcode:

# [gcode_macro STARTUP_ACTIONS]
# #initial_duration: 2.0          # Wartezeit in Sekunden nach Klipper-Ready (1–5 Sekunden reicht meist)
# gcode:
#     STARTUP
#     # Status-Meldung
#     {action_respond_info("I just made the bed")}

## 	Thermistor Types
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "NTC 100K beta 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"

# [input_shaper]
# shaper_type_x = ei
# shaper_freq_x = 89.2
# shaper_type_y = mzv
# shaper_freq_y = 53.4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.019
#*# pid_ki = 1.956
#*# pid_kd = 194.606
#*#
#*# [bed_mesh 100]
#*# version = 1
#*# points =
#*# 	-0.025000, 0.018750, 0.031250, 0.006250, -0.012500
#*# 	-0.056250, 0.018750, 0.031250, 0.018750, -0.031250
#*# 	-0.025000, -0.031250, 0.000000, -0.006250, -0.012500
#*# 	-0.062500, -0.050000, -0.006250, -0.031250, -0.018750
#*# 	-0.018750, -0.025000, 0.031250, 0.006250, 0.012500
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 140.0
#*# min_y = 42.0
#*# max_y = 158.0
#*#
#*# [probe]
#*# z_offset = 11.920
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.025000, -0.031250, -0.012500, -0.050000, -0.056250
#*# 	-0.018750, -0.006250, -0.006250, 0.000000, -0.043750
#*# 	-0.025000, -0.025000, -0.006250, 0.006250, -0.075000
#*# 	-0.043750, -0.031250, -0.031250, -0.050000, -0.081250
#*# 	-0.068750, -0.062500, -0.031250, -0.062500, -0.075000
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 145.0
#*# min_y = 30.0
#*# max_y = 158.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 64.8
#*# shaper_type_y = ei
#*# shaper_freq_y = 60.4
